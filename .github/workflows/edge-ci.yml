name: Edge Services CI

on:
  push:
    branches: [main, develop]
    paths:
      - 'edge/**'
      - '.github/workflows/edge-ci.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'edge/**'
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  DOCKER_BUILDKIT: 1

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [config, orchestrator, piper, stt, wakeword]
        platform: [linux/amd64, linux/arm64]
      fail-fast: false
    
    permissions:
      contents: read
      packages: write
      security-events: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up QEMU for multi-platform builds
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64,amd64
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build ${{ matrix.service }} for ${{ matrix.platform }}
        uses: docker/build-push-action@v5
        with:
          context: ./edge/services/${{ matrix.service }}
          platforms: ${{ matrix.platform }}
          push: false
          tags: edge-${{ matrix.service }}:${{ github.sha }}-${{ matrix.platform == 'linux/amd64' && 'amd64' || 'arm64' }}
          outputs: type=docker,dest=/tmp/image-${{ matrix.service }}-${{ matrix.platform == 'linux/amd64' && 'amd64' || 'arm64' }}.tar
      
      - name: Load Docker image
        run: |
          docker load --input /tmp/image-${{ matrix.service }}-${{ matrix.platform == 'linux/amd64' && 'amd64' || 'arm64' }}.tar
      
      - name: Run security scan with Trivy (amd64 only)
        if: matrix.platform == 'linux/amd64'
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: edge-${{ matrix.service }}:${{ github.sha }}-amd64
          format: 'sarif'
          output: 'trivy-${{ matrix.service }}.sarif'
      
      - name: Upload Trivy results to GitHub Security
        if: matrix.platform == 'linux/amd64'
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: 'trivy-${{ matrix.service }}.sarif'
          category: 'trivy-${{ matrix.service }}'
  
  docker-compose-validation:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up QEMU for ARM64 emulation
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Validate docker-compose.yml syntax
        run: |
          docker compose -f edge/docker-compose.yml config > /dev/null
          echo "✓ docker-compose.yml validation successful"
      
      - name: Check Raspberry Pi compatibility
        run: |
          echo "Checking Raspberry Pi OS compatibility..."
          echo "Expected: Debian-based Raspberry Pi OS 64-bit"
          grep -E "FROM.*debian|FROM.*raspbian|FROM.*python" edge/services/*/Dockerfile | head -10 || echo "✓ Dockerfile base images OK"
      
      - name: Build all services for amd64 (CI environment)
        run: |
          docker compose -f edge/docker-compose.yml build
      
      - name: Start services (timeout 60s)
        run: |
          timeout 60 docker compose -f edge/docker-compose.yml up -d || true
      
      - name: Check service health
        run: |
          docker compose -f edge/docker-compose.yml ps
          docker compose -f edge/docker-compose.yml logs --tail=20
      
      - name: Verify Python versions (Raspberry Pi compatible)
        run: |
          for service in config orchestrator piper stt wakeword; do
            if [ -f "edge/services/$service/requirements.txt" ]; then
              echo "Checking $service dependencies..."
              docker compose -f edge/docker-compose.yml exec -T $service pip list | grep -E "numpy|pandas|torch|tensorflow" || echo "✓ $service OK"
            fi
          done || true
      
      - name: Cleanup
        if: always()
        run: |
          docker compose -f edge/docker-compose.yml down -v

  dockerfile-lint:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Lint Dockerfiles
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: edge/services/*/Dockerfile
          ignore: DL3008,DL3009
