name: Edge ARM64 Raspberry Pi Testing

on:
  push:
    branches: [main, develop]
    paths:
      - 'edge/**'
      - '.github/workflows/edge-arm64-test.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'edge/**'
  workflow_dispatch:

jobs:
  arm64-compatibility-check:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up QEMU ARM64 emulation
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64
      
      - name: Check Dockerfile ARM64 compatibility
        run: |
          echo "Checking Dockerfiles for Raspberry Pi OS 64-bit (Debian-based) compatibility..."
          
          for dockerfile in edge/services/*/Dockerfile; do
            service=$(dirname $dockerfile | rev | cut -d'/' -f1 | rev)
            echo ""
            echo "=== Checking $service ==="
            
            # Check for ARM64 compatible base images
            base_image=$(grep "^FROM" "$dockerfile" | head -1 | awk '{print $2}')
            echo "Base image: $base_image"
            
            # Warn if using non-Debian-based images
            if grep -q "FROM alpine" "$dockerfile"; then
              echo "⚠ Alpine detected - ensure Python packages are ARM64 compatible"
            fi
            
            # Check for architecture-specific issues
            if grep -q "RUN apt-get install" "$dockerfile"; then
              echo "✓ Using apt-get (Debian/Raspberry Pi compatible)"
            fi
          done
      
      - name: Check requirements.txt for ARM64 compatibility
        run: |
          echo "Checking Python dependencies for ARM64 compatibility..."
          
          # Packages that commonly have ARM64 issues
          ARM_PROBLEMATIC="tensorflow torch tensorflow-lite apex nmslib"
          
          for service in config orchestrator piper stt wakeword; do
            if [ -f "edge/services/$service/requirements.txt" ]; then
              echo ""
              echo "=== Checking $service/requirements.txt ==="
              
              for package in $ARM_PROBLEMATIC; do
                if grep -q "^$package" "edge/services/$service/requirements.txt"; then
                  echo "⚠ $package found - verify ARM64 wheel availability"
                fi
              done
              
              # Check for version pinning (good for reproducibility)
              if grep -E "==" "edge/services/$service/requirements.txt" > /dev/null; then
                echo "✓ Version-pinned dependencies (good for ARM64)"
              fi
            fi
          done
      
      - name: Verify docker-compose ARM64 compatibility
        run: |
          echo "Verifying docker-compose configuration for ARM64..."
          
          # Check if services define platform
          if grep -q "platform:" edge/docker-compose.yml; then
            echo "✓ Platform specified in docker-compose.yml"
            grep "platform:" edge/docker-compose.yml
          else
            echo "⚠ No platform specified - will use host platform"
          fi
          
          # Check for architecture-specific port conflicts
          echo "Checking port configuration..."
          grep "ports:" -A 2 edge/docker-compose.yml || true

  dockerfile-arm64-build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [config, orchestrator, piper, stt, wakeword]
    
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build ${{ matrix.service }} for ARM64
        uses: docker/build-push-action@v5
        with:
          context: ./edge/services/${{ matrix.service }}
          platforms: linux/arm64
          push: false
          tags: edge-${{ matrix.service }}:arm64-${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  docker-compose-validation:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Validate docker-compose.yml syntax
        run: |
          cd edge
          docker compose config > /dev/null
          echo "✓ docker-compose.yml syntax is valid"
      
      - name: Build all services with docker compose
        run: |
          cd edge
          echo "Building all services for ARM64 using docker compose..."
          export DOCKER_DEFAULT_PLATFORM=linux/arm64
          docker compose build --no-cache --progress=plain
          echo "✓ docker compose build completed successfully"
      
      - name: Verify built images
        run: |
          cd edge
          echo "Verifying built images..."
          for service in config orchestrator piper stt wakeword; do
            if docker images | grep -q "edge-$service"; then
              echo "✓ $service image built"
            else
              echo "✗ $service image not found"
              exit 1
            fi
          done

  integration-test:
    runs-on: ubuntu-latest
    needs: [docker-compose-validation]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build services
        run: |
          cd edge
          export DOCKER_DEFAULT_PLATFORM=linux/arm64
          docker compose build
      
      - name: Start services and test dependencies
        run: |
          cd edge
          chmod +x test-dependencies.sh
          export DOCKER_DEFAULT_PLATFORM=linux/arm64
          
          # Run dependency test
          ./test-dependencies.sh || {
            echo "Dependency test failed, showing logs..."
            docker compose logs
            exit 1
          }
      
      - name: Run health checks
        run: |
          cd edge
          chmod +x test-health.sh
          
          # Ensure all services are up
          docker compose up -d
          
          # Wait for initialization
          sleep 30
          
          # Run health check
          ./test-health.sh || {
            echo "Health check failed, showing logs..."
            docker compose logs
            exit 1
          }
      
      - name: Test inter-service communication
        run: |
          cd edge
          echo "=== Testing Wyoming Protocol Communication ==="
          
          # Test orchestrator → STT
          docker compose exec -T orchestrator timeout 5 nc -zv stt 10300 && \
            echo "✓ Orchestrator → STT (port 10300) OK" || \
            { echo "✗ Orchestrator → STT FAILED"; exit 1; }
          
          # Test orchestrator → Piper
          docker compose exec -T orchestrator timeout 5 nc -zv piper 10200 && \
            echo "✓ Orchestrator → Piper (port 10200) OK" || \
            { echo "✗ Orchestrator → Piper FAILED"; exit 1; }
          
          # Test orchestrator → Wakeword
          docker compose exec -T orchestrator timeout 5 nc -zv wakeword 10400 && \
            echo "✓ Orchestrator → Wakeword (port 10400) OK" || \
            { echo "✗ Orchestrator → Wakeword FAILED"; exit 1; }
          
          echo "✓ All inter-service communications working"
      
      - name: Memory usage check
        run: |
          cd edge
          echo "=== Memory Usage Analysis ==="
          docker stats --no-stream --format "table {{.Name}}\t{{.MemUsage}}\t{{.MemPerc}}"
          
          total_mem=$(docker stats --no-stream --format "{{.MemUsage}}" | awk -F'/' '{print $1}' | awk '{sum+=$1} END {print sum}')
          echo ""
          echo "Total memory used: ~${total_mem}"
          
          if (( $(echo "$total_mem > 1800" | bc -l 2>/dev/null || echo "0") )); then
            echo "⚠ WARNING: Memory usage high - may struggle on 2GB Raspberry Pi"
            echo "   Recommendation: Use Raspberry Pi 4 with 4GB+ RAM"
          else
            echo "✓ Memory usage acceptable for 2GB Raspberry Pi"
          fi
      
      - name: Cleanup
        if: always()
        run: |
          cd edge
          docker compose down -v
          docker compose ps

  raspberry-pi-manifest:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Verify Raspberry Pi OS requirements
        run: |
          echo "Raspberry Pi OS 64-bit (Debian-based) Requirements Check"
          echo "==========================================================="
          echo ""
          
          # Check docker-compose version compatibility
          echo "1. Docker Compose requirement:"
          echo "   - Raspberry Pi OS: Docker Compose V2 installed"
          echo "   - Syntax: uses 'docker compose' (not 'docker-compose')"
          
          # Check for .env file template
          if [ -f "edge/.env.example" ]; then
            echo "   ✓ .env.example found"
          else
            echo "   ⚠ No .env.example - create template for Raspberry Pi configuration"
          fi
          
          echo ""
          echo "2. Storage requirements:"
          echo "   - Estimated: 2-4GB for base images"
          echo "   - Ensure Raspberry Pi has sufficient space"
          
          echo ""
          echo "3. Network configuration:"
          echo "   - Ensure ports 8000-8005 are available"
          echo "   - Check docker network: bridge (default)"
          
          echo ""
          echo "4. Memory requirements:"
          echo "   - Minimum: 2GB (tight fit)"
          echo "   - Recommended: 4GB+ for reliable operation"
          
          echo ""
          echo "5. CPU: ARMv8 64-bit (all Raspberry Pi 3, 4, 5 supported)"

  documentation-check:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check ARM64 documentation
        run: |
          echo "Checking ARM64 specific documentation..."
          
          if [ ! -f "edge/ARM64_SETUP.md" ]; then
            echo "⚠ Consider creating edge/ARM64_SETUP.md with:"
            echo "  - Raspberry Pi OS installation steps"
            echo "  - Docker installation for ARM64"
            echo "  - Performance tuning tips"
            echo "  - Troubleshooting guide"
          fi
          
          if grep -q "Raspberry Pi" edge/README.md; then
            echo "✓ Raspberry Pi mentioned in edge/README.md"
          else
            echo "⚠ Add Raspberry Pi specific instructions to edge/README.md"
          fi
