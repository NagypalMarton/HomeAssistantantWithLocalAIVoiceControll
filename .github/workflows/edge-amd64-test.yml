name: Edge AMD64 Integration Testing

on:
  push:
    branches: [main, develop]
    paths:
      - 'edge/**'
      - '.github/workflows/edge-amd64-test.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'edge/**'
  workflow_dispatch:

jobs:
  amd64-compatibility-check:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check Dockerfile AMD64 compatibility
        run: |
          echo "Checking Dockerfiles for AMD64 (x86_64) compatibility..."
          
          for dockerfile in edge/services/*/Dockerfile; do
            service=$(dirname $dockerfile | rev | cut -d'/' -f1 | rev)
            echo ""
            echo "=== Checking $service ==="
            
            # Check for AMD64 compatible base images
            base_image=$(grep "^FROM" "$dockerfile" | head -1 | awk '{print $2}')
            echo "Base image: $base_image"
            
            # Check for architecture-specific issues
            if grep -q "RUN apt-get install" "$dockerfile"; then
              echo "✓ Using apt-get (Debian/Ubuntu compatible)"
            fi
            
            if grep -q "RUN apk add" "$dockerfile"; then
              echo "✓ Using apk (Alpine compatible)"
            fi
          done
      
      - name: Check requirements.txt for AMD64 compatibility
        run: |
          echo "Checking Python dependencies for AMD64 compatibility..."
          
          for service in config orchestrator piper stt wakeword; do
            if [ -f "edge/services/$service/requirements.txt" ]; then
              echo ""
              echo "=== Checking $service/requirements.txt ==="
              
              # Check for version pinning (good for reproducibility)
              if grep -E "==" "edge/services/$service/requirements.txt" > /dev/null; then
                echo "✓ Version-pinned dependencies found"
              fi
              
              echo "✓ AMD64 has excellent Python package support"
            fi
          done
      
      - name: Verify docker-compose AMD64 compatibility
        run: |
          echo "Verifying docker-compose configuration for AMD64..."
          
          # Check if services define platform
          if grep -q "platform:" edge/docker-compose.yml; then
            echo "Platform specified in docker-compose.yml:"
            grep "platform:" edge/docker-compose.yml
          else
            echo "✓ No platform specified - will use native AMD64"
          fi

  dockerfile-amd64-build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [config, orchestrator, piper, stt, wakeword]
    
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build ${{ matrix.service }} for AMD64
        uses: docker/build-push-action@v5
        with:
          context: ./edge/services/${{ matrix.service }}
          platforms: linux/amd64
          push: false
          tags: edge-${{ matrix.service }}:amd64-${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  docker-compose-validation:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Validate docker-compose.yml syntax
        run: |
          cd edge
          docker compose config > /dev/null
          echo "✓ docker-compose.yml syntax is valid"
      
      - name: Build all services with docker compose
        run: |
          cd edge
          echo "Building all services for AMD64 using docker compose..."
          export DOCKER_DEFAULT_PLATFORM=linux/amd64
          docker compose build --progress=plain
          echo "✓ docker compose build completed successfully"
      
      - name: Verify built images
        run: |
          cd edge
          echo "Verifying built images..."
          for service in config orchestrator piper stt wakeword; do
            if docker images | grep -q "edge-$service"; then
              echo "✓ $service image built"
            else
              echo "✗ $service image not found"
              exit 1
            fi
          done

  integration-test:
    runs-on: ubuntu-latest
    needs: [docker-compose-validation]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build services
        run: |
          cd edge
          export DOCKER_DEFAULT_PLATFORM=linux/amd64
          docker compose build
      
      - name: Start services and test dependencies
        run: |
          cd edge
          chmod +x test-dependencies.sh
          export DOCKER_DEFAULT_PLATFORM=linux/amd64
          
          # Run dependency test
          ./test-dependencies.sh || {
            echo "Dependency test failed, showing logs..."
            docker compose logs
            exit 1
          }
      
      - name: Run health checks
        run: |
          cd edge
          chmod +x test-health.sh
          
          # Ensure all services are up
          docker compose up -d
          
          # Wait for initialization
          sleep 30
          
          # Run health check
          ./test-health.sh || {
            echo "Health check failed, showing logs..."
            docker compose logs
            exit 1
          }
      
      - name: Test inter-service communication
        run: |
          cd edge
          echo "=== Testing Wyoming Protocol Communication ==="
          
          # Test orchestrator → STT
          docker compose exec -T orchestrator timeout 5 nc -zv stt 10300 && \
            echo "✓ Orchestrator → STT (port 10300) OK" || \
            { echo "✗ Orchestrator → STT FAILED"; exit 1; }
          
          # Test orchestrator → Piper
          docker compose exec -T orchestrator timeout 5 nc -zv piper 10200 && \
            echo "✓ Orchestrator → Piper (port 10200) OK" || \
            { echo "✗ Orchestrator → Piper FAILED"; exit 1; }
          
          # Test orchestrator → Wakeword
          docker compose exec -T orchestrator timeout 5 nc -zv wakeword 10400 && \
            echo "✓ Orchestrator → Wakeword (port 10400) OK" || \
            { echo "✗ Orchestrator → Wakeword FAILED"; exit 1; }
          
          echo "✓ All inter-service communications working"
      
      - name: Memory usage check
        run: |
          cd edge
          echo "=== Memory Usage Analysis ==="
          docker stats --no-stream --format "table {{.Name}}\t{{.MemUsage}}\t{{.MemPerc}}"
          
          total_mem=$(docker stats --no-stream --format "{{.MemUsage}}" | awk -F'/' '{print $1}' | awk '{sum+=$1} END {print sum}')
          echo ""
          echo "Total memory used: ~${total_mem}"
          
          if (( $(echo "$total_mem > 3500" | bc -l 2>/dev/null || echo "0") )); then
            echo "⚠ WARNING: Memory usage very high for AMD64"
            echo "   Recommendation: Optimize services or increase available RAM"
          else
            echo "✓ Memory usage acceptable for typical AMD64 systems"
          fi
      
      - name: Performance benchmark
        run: |
          cd edge
          echo "=== AMD64 Performance Metrics ==="
          
          # Check container CPU usage
          docker stats --no-stream --format "table {{.Name}}\t{{.CPUPerc}}"
          
          echo ""
          echo "✓ AMD64 typically has better performance than ARM64"
          echo "✓ Expected faster inference times for Whisper and Piper"
      
      - name: Cleanup
        if: always()
        run: |
          cd edge
          docker compose down -v
          docker compose ps

  development-environment-check:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Verify AMD64 development environment requirements
        run: |
          echo "AMD64 (x86_64) Development Environment Requirements"
          echo "==================================================="
          echo ""
          
          # Check docker-compose version compatibility
          echo "1. Docker Compose requirement:"
          echo "   - Linux/Windows/macOS: Docker Compose V2"
          echo "   - Syntax: uses 'docker compose' (not 'docker-compose')"
          
          # Check for .env file template
          if [ -f "edge/.env.example" ]; then
            echo "   ✓ .env.example found"
          else
            echo "   ⚠ No .env.example - create template for configuration"
          fi
          
          echo ""
          echo "2. Storage requirements:"
          echo "   - Estimated: 2-4GB for base images"
          echo "   - AMD64 images generally smaller than emulated ARM64"
          
          echo ""
          echo "3. Network configuration:"
          echo "   - Ensure ports 8000-8005 are available"
          echo "   - Check docker network: bridge (default)"
          
          echo ""
          echo "4. Memory requirements:"
          echo "   - Minimum: 2GB (basic operation)"
          echo "   - Recommended: 4GB+ for development"
          echo "   - Production: 8GB+ recommended"
          
          echo ""
          echo "5. CPU: x86_64 (AMD64) - Any modern Intel or AMD processor"
          echo ""
          echo "6. Operating Systems:"
          echo "   - Linux (Ubuntu, Debian, Fedora, etc.)"
          echo "   - Windows 10/11 with WSL2"
          echo "   - macOS (Intel or Apple Silicon with Rosetta 2)"

  documentation-check:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check AMD64 documentation
        run: |
          echo "Checking AMD64 specific documentation..."
          
          if [ ! -f "edge/AMD64_SETUP.md" ]; then
            echo "⚠ Consider creating edge/AMD64_SETUP.md with:"
            echo "  - Development environment setup"
            echo "  - Docker installation for different OSes"
            echo "  - Performance optimization tips"
            echo "  - Troubleshooting guide"
          fi
          
          if grep -q "AMD64\|x86_64\|development" edge/README.md; then
            echo "✓ Development environment mentioned in edge/README.md"
          else
            echo "⚠ Add development environment instructions to edge/README.md"
          fi
